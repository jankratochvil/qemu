From ddf94a2b7b1563a7a4a56734d21e23036b789da1 Mon Sep 17 00:00:00 2001
From: Eduardo Habkost <ehabkost@redhat.com>
Date: Fri, 15 Jul 2011 20:40:38 -0300
Subject: [RHEL6 qemu-kvm PATCH] CVE-2011-2527: os-posix: set groups properly for -runas

RH-Author: Eduardo Habkost <ehabkost@redhat.com>
Message-id: <patch-29843-clone-for-rhel61-rhel61>
Patchwork-id: 29962
O-Subject: [RHEL 6.2 6.1.z qemu-kvm PATCH] CVE-2011-2527: os-posix: set groups properly for -runas
Bugzilla: 722582
RH-Acked-by: Amos Kong <akong@redhat.com>
RH-Acked-by: Jes Sorensen <Jes.Sorensen@redhat.com>
RH-Acked-by: Petr Matousek <pmatouse@redhat.com>

Bugzilla (6.2): https://bugzilla.redhat.com/show_bug.cgi?id=722583
Bugzilla (6.1.z): https://bugzilla.redhat.com/show_bug.cgi?id=722582
CVE: CVE-2011-2527

Backport of:

commit cc4662f9642995c78bed587707eeb9ad8500035b
Author: Stefan Hajnoczi <stefanha@linux.vnet.ibm.com>
Date:   Sat Jul 9 10:22:07 2011 +0100

    os-posix: set groups properly for -runas

    Andrew Griffiths reports that -runas does not set supplementary group
    IDs.  This means that gid 0 (root) is not dropped when switching to an
    unprivileged user.

    Add an initgroups(3) call to use the -runas user's /etc/groups
    membership to update the supplementary group IDs.

    Signed-off-by: Stefan Hajnoczi <stefanha@linux.vnet.ibm.com>
    Acked-by: Chris Wright <chrisw@sous-sol.org>
    Signed-off-by: Blue Swirl <blauwirbel@gmail.com>

Signed-off-by: Eduardo Habkost <ehabkost@redhat.com>
---
 vl.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

Signed-off-by: Eduardo Habkost <ehabkost@redhat.com>
---
 vl.c |    6 ++++++
 1 files changed, 6 insertions(+), 0 deletions(-)

diff --git a/vl.c b/vl.c
index 4e800b2..7ebb5a7 100644
--- a/vl.c
+++ b/vl.c
@@ -27,6 +27,7 @@
 #include <time.h>
 #include <errno.h>
 #include <sys/time.h>
+#include <grp.h>
 #include <zlib.h>
 
 /* Needed early for CONFIG_BSD etc. */
@@ -6823,6 +6824,11 @@ int main(int argc, char **argv, char **envp)
             fprintf(stderr, "Failed to setgid(%d)\n", pwd->pw_gid);
             exit(1);
         }
+        if (initgroups(pwd->pw_name, pwd->pw_gid) < 0) {
+            fprintf(stderr, "Failed to initgroups(\"%s\", %d)\n",
+                    pwd->pw_name, pwd->pw_gid);
+            exit(1);
+        }
         if (setuid(pwd->pw_uid) < 0) {
             fprintf(stderr, "Failed to setuid(%d)\n", pwd->pw_uid);
             exit(1);
-- 
1.7.3.2

